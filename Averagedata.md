# 平均数据处理

说明：由于源数据中控制码对数据已有标识，应该不用再进行异常值空值查找，直接跳到下一步平均值处理

## 一、各数据项说明

1. #### 根据控制码确认数据是否可以参与平均值的计算中

   数据质量状况

   ​      质量控制方法：

   ​      在本次数据集制作过程中，对所有要素观测数据均给出了质量信息--质量控制码。质量控制码的规定及含义

   ​            质量控制码  含义

   ​                   0    数据正确

   ​                   1    数据可疑

   ​                   2    数据错误

   ​                   8    数据缺测或无观测任务

   ​                   9    数据未进行质量控制

2. #### 各数据项含义

   各要素项   ：

   32766   数据缺测或无观测任务

   气压日极值  :

   +20000  气压极值取自定时值，在原值上加20000

   日最小相对湿度 :

    +300    最小相对湿度取自定时值，在原值上加300

   风速   :

    +1000   当风速超过仪器测量上限时，在上限数据基础上加1000

   风向    :

   1-17    用数字表示风向方位，17表示静风（对方向无影响）

   ​                +100    当表示风向为八风向时，在原值上加100

   ​                90X 风向出现X个时，风向数据用个数X表示

   ​                95X 风向至少出现X个时，风向数据用个数X表示

    降水量 :

    32700   表示降水"微量"，小于0.1mm

   ​                32XXX   XXX为纯雾露霜

   ​                31XXX   XXX为雨和雪的总量

   ​                30XXX   XXX为雪量(仅包括雨夹雪，雪暴）

    蒸发量  :

   32700   表示蒸发器结冰

   ​                +1000   蒸发器中注入的水全部蒸发，在注入的水量数据基础上加1000

   ​            0cm地温 +10000  实际温度（零上）超仪器上限刻度，在上限数据基础上加10000

   ​                -10000  实际温度（零下）超仪器下限刻度，在下限数据基础上减10000

## 二、程序框架

1. 遍历文件夹sta_no每个文件
   1. 读取第一行，ans存下日期
   2. 读取每一行
      1. 如果月份相同，进行求和操作
         1. 循环每一类数据，若为合法值，则求和
      2. 如果不同，则求平均数，写入到目标文件中,按月份修改日期
      3. 更新ans
   3. 将最后一个月的数据写入文件中

> 参考文献：全国地面气候资料（1961-1990）统计方法
			 地面气象观测规范

> [中国地面气候资料日值数据集(V3.0)](http:://data.cma.cn/data/cdcdetail/dataCode/SURF_CLI_CHN_MUL_DAY_V3.0.html)

> 数据说明文档来源[SURF_CLI_CHN_MUL_DAY_DOCU_C.Doc](http:://image.data.cma.cn/static/doc/A/SURF_CLI_CHN_MUL_DAY_V3.0/SURF_CLI_CHN_MUL_DAY_DOCU_C.doc)


## 平均风向计算

#### u、v矢量换算为方向角

- `v`是南北分量，`u`是东西方向分量
- 由于`y=arctan(x)`值域为`-π/2~π/2`,应转化为`0~360`方向角
- 前四种情况在四个象限按顺时针旋转，后四种是北东南西四个方向

~~~c++
const double PI = 3.1415926535;
const double WindAngle = 22.5*PI/180;
double u[22], v[22];//风向，v是南北分量，u是东西方向分量
double wind_angle(double u, double v){
    double temp = atan(u/v)*180/PI;
    if(u > 0 && v > 0){
        return temp;
    }
    else if(u > 0 && v < 0){
        return 180+temp; 
    }
    else if(u < 0 && v < 0){
        return 180+temp;
    }
    else if(u < 0 && v > 0){
        return 360+temp;
    }
    else if(u == 0 && v > 0){
        return 0;
    }
    else if(u == 0 && v < 0){
        return 180;
    }
    else if(u > 0 && v == 0){
        return 90;
    }
    else if(u < 0 && v == 0){
        return 270;
    }
    else if(u == 0 && v == 0){
        return 0;
    }
}
~~~

#### 运用公式：
> 单位矢量法：`Au`为单位矢量的平均风向 ,`U` 为单位风速矢量在东西方向上的平均分量 ,`V`  为单位风速矢量在南北方向上的平均分量。

$$
A_u = arctan({\frac UV})
$$

$$
U = {\frac 1N} * \sum_{i=0}^N * sin(A_i)
$$

$$
V = {\frac 1N} * \sum_{i=0}^N * cos(A_i)
$$

~~~c++
//get_sum(Dataclimite &info)里        

else if((0 == info.item[i][1]|| 9 == info.item[i][1]) && info.item[i][0] >= 1 && info.item[i][0] <= 16){
            u[i] += sin(info.item[i][0]*WindAngle);
            v[i] += cos(info.item[i][0]*WindAngle);
            res[i][1]++;
        }

//get_ave(Dataclimite &a)里
if(i == 19 || i == 21){
    u[i] /= res[i][1] * 1.0;
    v[i] /= res[i][1] * 1.0;
    a.item[i][0] = wind_angle(u[i], v[i]);  
    a.item[i][1] = 0;
    //cout << u[i] << " " << v[i] << " " << a.item[i][0] << endl;
    u[i] = 0, v[i] = 0;
}

~~~

测试数据：`15 16 14 16 7 8 15 7 8 16 15 8 14 7 8 7 16 13 16 16 15 8 1 14 14 7 13 15 15 15 8`

计算结果：`321.524`
